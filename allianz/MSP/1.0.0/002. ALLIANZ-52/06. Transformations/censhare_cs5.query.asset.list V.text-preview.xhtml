<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
</head>
<body>
<pre>
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;xsl:stylesheet version=&quot;2.0&quot;
 &nbsp;xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot;
 &nbsp;xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot;
 &nbsp;xmlns:cs=&quot;http://www.censhare.com/xml/3.0.0/xpath-functions&quot;
 &nbsp;xmlns:censhare=&quot;http://www.censhare.com/xml/3.0.0/xpath-functions&quot;
 &nbsp;xmlns:csc=&quot;http://www.censhare.com/censhare-custom&quot;
 &nbsp;exclude-result-prefixes=&quot;#all&quot;&gt;

 &nbsp;&lt;!-- output --&gt;
 &nbsp;&lt;xsl:output indent=&quot;no&quot; method=&quot;xml&quot; omit-xml-declaration=&quot;no&quot; encoding=&quot;UTF-8&quot;/&gt;

 &nbsp;&lt;!-- view model transformation for asset list --&gt;
 &nbsp;&lt;!-- change elements: --&gt;
 &nbsp;&lt;!-- - traits/workflow: add attributes &quot;isGroup&quot;, &quot;isMe&quot; --&gt;
 &nbsp;&lt;!-- - actual_notes: reduce to attribute &quot;count&quot; --&gt;
 &nbsp;&lt;!-- - actual_root: add attribute &quot;pageCount&quot; and reduce &quot;storage_items&quot; --&gt;
 &nbsp;&lt;!-- - planning_root: reduce to attribute &quot;count&quot; --&gt;
 &nbsp;&lt;!-- - messages: reduce to attribute &quot;count&quot; --&gt;
 &nbsp;&lt;!-- - storage_items: reduce to &quot;master&quot;, &quot;preview&quot; and &quot;thumbnail&quot; storage keys --&gt;
 &nbsp;&lt;!-- remove elements: --&gt;
 &nbsp;&lt;!-- - relations --&gt;
 &nbsp;&lt;!-- add elements (if data exists): --&gt;
 &nbsp;&lt;!-- - actualNotes --&gt;
 &nbsp;&lt;!-- - address --&gt;
 &nbsp;&lt;!-- - categories --&gt;
 &nbsp;&lt;!-- - contentUpdates --&gt;
 &nbsp;&lt;!-- - gdpr --&gt;
 &nbsp;&lt;!-- - geometryUpdates --&gt;
 &nbsp;&lt;!-- - goal --&gt;
 &nbsp;&lt;!-- - keywordRefs --&gt;
 &nbsp;&lt;!-- - masterStorageItems --&gt;
 &nbsp;&lt;!-- - person --&gt;
 &nbsp;&lt;!-- - preview --&gt;
 &nbsp;&lt;!-- - productCategories --&gt;
 &nbsp;&lt;!-- - rating --&gt;
 &nbsp;&lt;!-- - task --&gt;
 &nbsp;&lt;!-- - tasks --&gt;
 &nbsp;&lt;!-- - thumbnail --&gt;
 &nbsp;&lt;!-- - variants --&gt;
 &nbsp;&lt;!-- - variantUpdates --&gt;
 &nbsp;&lt;!-- - workingCopies --&gt;
 
 &nbsp;&lt;!-- global variables --&gt;
 &nbsp;&lt;xsl:variable name=&quot;customTraits&quot; select=&quot;('product')&quot; /&gt;
 &nbsp;&lt;xsl:variable name=&quot;addedTraits&quot; select=&quot;($customTraits, 'access_rights', 'checked_out', 'created', 'default', 'display', 'domain', 'facebook', 'file_meta_data', 'ids', 'modified', 'resource_asset', 'resource_planning', 'state', 'type', 'twitter', 'usage_rights', 'versioning', 'workflow', 'youtube')&quot;/&gt;
 &nbsp;&lt;xsl:variable name=&quot;urlPrefix&quot; select=&quot;'/rest/'&quot;/&gt;
 &nbsp;&lt;xsl:variable name=&quot;assetServiceUrl&quot; select=&quot;'/rest/service/assets/'&quot;/&gt;
 &nbsp;&lt;xsl:variable name=&quot;loggedInPartyID&quot; select=&quot;system-property('censhare:party-id')&quot;/&gt;
 &nbsp;&lt;xsl:variable name=&quot;locale&quot; select=&quot;cs:master-data('party')[@id=$loggedInPartyID]/@locale&quot;/&gt;
 &nbsp;&lt;xsl:variable name=&quot;language&quot; select=&quot;if ($locale) then $locale else 'en'&quot;/&gt;

 &nbsp;&lt;!-- asset match --&gt;
 &nbsp;&lt;xsl:template match=&quot;asset&quot;&gt;
 &nbsp; &nbsp;&lt;asset&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;actual_root&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;planning_root&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;actual_notes&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;messages&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;storage_items&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;traits&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;aspects&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;!--xsl:copy-of select=&quot;relations&quot;/--&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;actualNotes&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;address&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;categories&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;contentUpdates&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;gdpr&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;geometryUpdates&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;goal&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;keywordRefs&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;masterStorageItems&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;person&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;preview&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;productCategories&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;rating&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;task&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;tasks&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;thumbnail&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;variants&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;variantUpdates&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:call-template name=&quot;workingCopies&quot;/&gt;
 &nbsp; &nbsp;&lt;/asset&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;xsl:template match=&quot;actual_root&quot;&gt;
 &nbsp; &nbsp;&lt;actual_root page_count=&quot;{count(pages/page)}&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;traits&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;storage_items&quot;/&gt;
 &nbsp; &nbsp;&lt;/actual_root&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;xsl:template match=&quot;planning_root&quot;&gt;
 &nbsp; &nbsp;&lt;planning_root page_count=&quot;{count(pages/page)}&quot;/&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;xsl:template match=&quot;actual_notes&quot;&gt;
 &nbsp; &nbsp;&lt;actual_notes count=&quot;{count(note)}&quot;/&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;xsl:template match=&quot;messages&quot;&gt;
 &nbsp; &nbsp;&lt;messages count=&quot;{count(message)}&quot;/&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;xsl:template match=&quot;storage_items&quot;&gt;
 &nbsp; &nbsp;&lt;storage_items&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;storage_item[@type='master']&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;storage_item[@type='thumbnail']&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;storage_item[@type='preview']&quot;/&gt;
 &nbsp; &nbsp;&lt;/storage_items&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;xsl:template match=&quot;storage_item&quot;&gt;
 &nbsp; &nbsp;&lt;storage_item&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;traits&quot;/&gt;
 &nbsp; &nbsp;&lt;/storage_item&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;xsl:template match=&quot;traits&quot;&gt;
 &nbsp; &nbsp;&lt;traits&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:apply-templates select=&quot;*&quot; mode=&quot;traits&quot;/&gt;
 &nbsp; &nbsp;&lt;/traits&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- add attributes &quot;isGroup&quot; and &quot;isMe&quot; to &quot;workflow&quot; trait --&gt;
 &nbsp;&lt;xsl:template match=&quot;workflow&quot; mode=&quot;traits&quot; priority=&quot;2.0&quot;&gt;
 &nbsp; &nbsp;&lt;workflow&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;workflowTarget&quot; select=&quot;@workflowTarget&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;workflowParty&quot; select=&quot;if ($workflowTarget) then cs:master-data('party')[@id=$workflowTarget] else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$workflowParty&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;isGroup&quot; select=&quot;$workflowParty/@isgroup='1'&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;isMe&quot; select=&quot;boolean($workflowTarget=$loggedInPartyID)&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;*&quot;/&gt;
 &nbsp; &nbsp;&lt;/workflow&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;xsl:template match=&quot;*&quot; mode=&quot;traits&quot; priority=&quot;1.0&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;node-name(.)=$addedTraits&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;.&quot;/&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;actualNotes&quot; element --&gt;
 &nbsp;&lt;!-- &lt;actualNotes count=&quot;10&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;actualNotes&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;actualNotesElement&quot; select=&quot;traits/actual_notes&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$actualNotesElement&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;actualNotes&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;count&quot; select=&quot;count(traits/actual_notes/note)&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/actualNotes&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;address&quot; element --&gt;
 &nbsp;&lt;!-- &lt;address work=&quot;Paul-Gerhardt-Allee 50, 81245 MÃ¼nchen, 81245, Germany&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;address&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;addressElement&quot; select=&quot;traits/address/address/addressType&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;workElement&quot; select=&quot;$addressElement/value[@value='work']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$workElement&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;address&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;work&quot; select=&quot;string-join((string-join(($workElement/street/@value, $workElement/streetNumber/@value), ' '), string-join(($workElement/zipCode/@value, $workElement/city/@value), ' '), $workElement/zipCode/@value, $workElement/countryCode/@label_value), ', ')&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/address&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;categories&quot; element --&gt;
 &nbsp;&lt;!-- &lt;categories censhare:_annotation.arraygroup=&quot;true&quot;&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;category value=&quot;censhare:category.persona&quot; label=&quot;Persona&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &lt;/categories&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;categories&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;categories&quot; select=&quot;traits/type/category/value&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$categories&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;items&quot; as=&quot;element(category)*&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$categories&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;category
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value=&quot;{@value}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;label=&quot;{if (@label_category) then @label_category else csc:getLocalizedAssetName(@value)}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/category&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:variable&gt;
 &nbsp; &nbsp; &nbsp;&lt;categories censhare:_annotation.arraygroup=&quot;true&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$items&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sort select=&quot;@label&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;.&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp;&lt;/categories&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;contentUpdates&quot; element --&gt;
 &nbsp;&lt;!-- &lt;contentUpdates countParent=&quot;1&quot; countChild=&quot;1&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;contentUpdates&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;parentAssetRels&quot; select=&quot;relations/relation[@type='actual.' and @direction='parent' and traits/state/@hasUpdateContent='true']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;childAssetRels&quot; select=&quot;relations/relation[@type='actual.' and @direction='child' and traits/state/@hasUpdateContent='true']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels or $childAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;contentUpdates
 &nbsp; &nbsp; &nbsp; &nbsp;countParent=&quot;{count($parentAssetRels)}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;countChild=&quot;{count($childAssetRels)}&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;/contentUpdates&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;gdpr&quot; element --&gt;
 &nbsp;&lt;!-- &lt;gdpr isLoggedInPartyPersonPage=&quot;true&quot; isPartyUser=&quot;true&quot; viewContactDataAllowed=&quot;true&quot; viewPersonalDataAllowed=&quot;true&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;gdpr&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;traits/type/@type='person.'&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;partyAssetId&quot; select=&quot;cs:master-data('party')[@id=$loggedInPartyID]/@party_asset_id&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;isPartyUser&quot; select=&quot;exists(cs:master-data('party')[@party_asset_id=traits/ids/@id])&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;isLoggedInPartyPersonPage&quot; select=&quot;traits/ids/@id=$partyAssetId&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;gdpr
 &nbsp; &nbsp; &nbsp; &nbsp;isLoggedInPartyPersonPage=&quot;{$isLoggedInPartyPersonPage}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;isPartyUser=&quot;{$isPartyUser}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;viewContactDataAllowed=&quot;{not($isPartyUser) or $isLoggedInPartyPersonPage or traits/address/privacyAllowViewContactData/@value='true'}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;viewPersonalDataAllowed=&quot;{not($isPartyUser) or $isLoggedInPartyPersonPage or traits/address/privacyAllowViewPersonalData/@value='true'}&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;/gdpr&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;geometryUpdates&quot; element --&gt;
 &nbsp;&lt;!-- &lt;geometryUpdates countParent=&quot;1&quot; self=&quot;true&quot; countChild=&quot;1&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;geometryUpdates&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;parentAssetRels&quot; select=&quot;relations/relation[@type='target.' and @direction='parent' and traits/state/@hasUpdateChildGeometry='true']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;hasUpdateFlag&quot; select=&quot;traits/state/@hasUpdateGeometry='true'&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;childAssetRels&quot; select=&quot;relations/relation[@type='target.' and @direction='child' and traits/state/@hasUpdateChildGeometry='true']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels or $hasUpdateFlag or $childAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;geometryUpdates
 &nbsp; &nbsp; &nbsp; &nbsp;countParent=&quot;{count($parentAssetRels)}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;self=&quot;{$hasUpdateFlag}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;countChild=&quot;{count($childAssetRels)}&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;/geometryUpdates&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;goal&quot; element --&gt;
 &nbsp;&lt;!-- &lt;goal startDate=&quot;2015-12-31T23:00:00Z&quot; startValue=&quot;0&quot; endDate=&quot;2016-04-29T22:00:00Z&quot; endValue=&quot;100&quot; totalAchievedPercent=&quot;60&quot; relativeAchievedPercent=&quot;205.4&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;goal&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;goalTraitElement&quot; select=&quot;traits/goal&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$goalTraitElement&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;goal&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$goalTraitElement[1]/@startDate&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$goalTraitElement[1]/@startValue&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$goalTraitElement[1]/@endDate&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$goalTraitElement[1]/@endValue&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;startDate&quot; select=&quot;xs:dateTime($goalTraitElement[1]/@startDate)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;endDate&quot; select=&quot;xs:dateTime($goalTraitElement[1]/@endDate)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenStartValue&quot; select=&quot;$goalTraitElement[1]/@startValue&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;startValue&quot; select=&quot;if ($givenStartValue) then $givenStartValue else 0&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;endValue&quot; select=&quot;$goalTraitElement[1]/@endValue&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;achievedElements&quot; select=&quot;$goalTraitElement[1]/achievedDate/value[exists(achievedValue)]&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;lastAchievedDate&quot; select=&quot;max(for $x in $achievedElements return xs:dateTime($x/@value))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;lastAchievedValue&quot; select=&quot;$achievedElements[xs:dateTime(@value)=$lastAchievedDate]/achievedValue[1]/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;totalAchievedPercent&quot; select=&quot;(($lastAchievedValue - $startValue) * 100) div ($endValue - $startValue)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;endDateSeconds&quot; select=&quot;if (exists($startDate) and exists($endDate)) then ($endDate - $startDate) div xs:dayTimeDuration('PT1S') else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;lastAchievedDateSeconds&quot; select=&quot;if (exists($lastAchievedDate) and exists($startDate)) then ($lastAchievedDate - $startDate) div xs:dayTimeDuration('PT1S') else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;lastAchievedGoalValue&quot; select=&quot;(($lastAchievedDateSeconds * ($endValue - $startValue)) div $endDateSeconds) + $startValue&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;relativeAchievedPercent&quot; select=&quot;(($lastAchievedValue - $startValue) * 100) div ($lastAchievedGoalValue - $startValue)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$totalAchievedPercent&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;totalAchievedPercent&quot; select=&quot;$totalAchievedPercent&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$relativeAchievedPercent&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;relativeAchievedPercent&quot; select=&quot;$relativeAchievedPercent&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/goal&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;keywordRefs&quot; element --&gt;
 &nbsp;&lt;!-- &lt;keywordRefs censhare:_annotation.arraygroup=&quot;true&quot;&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;keywordRef value=&quot;/m/012mj&quot; label=&quot;Alcoholic drink&quot; relevance=&quot;48.66618952318724&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &lt;/keywordRefs&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;keywordRefs&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;keywordRefs&quot; select=&quot;traits/category/keywordRef/value&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$keywordRefs&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;items&quot; as=&quot;element(keywordRef)*&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$keywordRefs&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;keywordRef
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value=&quot;{@value}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;label=&quot;{if (@label_category) then @label_category else csc:getLocalizedAssetName(@value)}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relevance=&quot;{@relevance}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/keywordRef&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:variable&gt;
 &nbsp; &nbsp; &nbsp;&lt;keywordRefs censhare:_annotation.arraygroup=&quot;true&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$items&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sort select=&quot;@label&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;.&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp;&lt;/keywordRefs&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;masterStorageItems&quot; element --&gt;
 &nbsp;&lt;!-- &lt;masterStorageItems count=&quot;1&quot; size=&quot;4158&quot; mimetype=&quot;image/jpeg&quot; mimetypeLabel=&quot;JPEG image&quot; audioFormat=&quot;mp4a&quot; bitrateMps=&quot;126.0&quot; --&gt;
 &nbsp;&lt;!-- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; durationSec=&quot;257.0&quot; color=&quot;rgb&quot; dpi=&quot;72&quot; framesPerSecond=&quot;30.0&quot; lineCount=&quot;1&quot; wordCount=&quot;1&quot; charCount=&quot;1&quot; --&gt;
 &nbsp;&lt;!-- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; videoFormat=&quot;H.264&quot; heightPx=&quot;200&quot; widthPx=&quot;200&quot; appVersion=&quot;6.0&quot; appVersionLabel=&quot;Adobe InDesign 6.0 (CS-4)&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;masterStorageItems&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;masterStorageItems&quot; select=&quot;(actual_root, actual_root/pages/page)/storage_items/storage_item[@type='master']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$masterStorageItems&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;masterStorageItems
 &nbsp; &nbsp; &nbsp; &nbsp;count=&quot;{count($masterStorageItems)}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;size=&quot;{round(sum($masterStorageItems/traits/file_meta_data/@fileLength))}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;mimetype=&quot;{$masterStorageItems[1]/traits/file_meta_data/@mimetype}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp;mimetypeLabel=&quot;{$masterStorageItems[1]/traits/file_meta_data/@label_mimetype}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@audioFormat&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@bitrateMps&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@durationSec&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@color&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@dpi&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@framesPerSecond&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@heightPx&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@videoFormat&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$masterStorageItems[1]/traits/file_meta_data/@widthPx&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$masterStorageItems/traits/file_meta_data/@lineCount&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;lineCount&quot; select=&quot;round(sum($masterStorageItems/traits/file_meta_data/@lineCount))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$masterStorageItems/traits/file_meta_data/@wordCount&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;wordCount&quot; select=&quot;round(sum($masterStorageItems/traits/file_meta_data/@wordCount))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$masterStorageItems/traits/file_meta_data/@charCount&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;charCount&quot; select=&quot;round(sum($masterStorageItems/traits/file_meta_data/@charCount))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;typeElement&quot; select=&quot;$masterStorageItems[1]/traits/type&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$typeElement&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$typeElement/@appVersion&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$typeElement/@label_appVersion&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;appVersionLabel&quot; select=&quot;$typeElement/@label_appVersion&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/masterStorageItems&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;person&quot; element --&gt;
 &nbsp;&lt;!-- &lt;person/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;person&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;personalDataElement&quot; select=&quot;traits/address/address/personalData&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;comElement&quot; select=&quot;traits/address/address/comTelType&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;emailElement&quot; select=&quot;traits/address/address/comEmailType&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement or $comElement or $emailElement&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;person&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;birthday&quot; select=&quot;$personalDataElement/birthday/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$birthday&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;birthday&quot; select=&quot;$birthday&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;age&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;month-from-date(current-date()) &gt; month-from-date($birthday) or month-from-date(current-date()) = month-from-date($birthday) and day-from-date(current-date()) &gt;= day-from-date($birthday)&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;year-from-date(current-date()) - year-from-date($birthday)&quot; /&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;year-from-date(current-date()) - year-from-date($birthday) - 1&quot; /&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:attribute&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/birthplace&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;birthplace&quot; select=&quot;$personalDataElement/birthplace/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/gender&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;gender&quot; select=&quot;$personalDataElement/gender/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/title&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;title&quot; select=&quot;$personalDataElement/title/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/firstName&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;firstName&quot; select=&quot;$personalDataElement/firstName/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/middleName&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;middleName&quot; select=&quot;$personalDataElement/middleName/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/lastName&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;lastName&quot; select=&quot;$personalDataElement/lastName/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$personalDataElement/function&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;function&quot; select=&quot;$personalDataElement/function/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$comElement/value[@value='cell']&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;cellPhone&quot; select=&quot;$comElement/value[@value='cell']/uriTel/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$emailElement&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;email&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$emailElement/value[@value='work']&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;work&quot; select=&quot;$emailElement/value[@value='work']/uriMailTo/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$emailElement/value[@value='home']&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;home&quot; select=&quot;$emailElement/value[@value='home']/uriMailTo/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/email&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/person&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;!-- creates &quot;preview&quot; element --&gt;
 &nbsp;&lt;!-- &lt;preview url=&quot;/rest/service/assets/asset/id/294464/version/2/element/actual/0/storage/thumbnail/file/485731.jpg&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;preview&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;storageItem&quot; select=&quot;if (exists(actual_root/storage_items/storage_item[@type='preview'])) then actual_root/storage_items/storage_item[@type='preview'] else actual_root/pages/page[1]/storage_items/storage_item[@type='preview']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;url&quot; select=&quot;if ($storageItem) then (replace($storageItem/@url,'censhare:///',$urlPrefix)) else ()&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$url&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;preview url=&quot;{$url}&quot;/&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;
 &nbsp;
 &nbsp;&lt;!-- creates &quot;productCategories&quot; element --&gt;
 &nbsp;&lt;!-- &lt;productCategories censhare:_annotation.arraygroup=&quot;true&quot;&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;productCategory value=&quot;234683&quot; label=&quot;Bicycles&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &lt;/productCategories&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;productCategories&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;productCategories&quot; select=&quot;traits/product/category/value&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$productCategories&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;items&quot; as=&quot;element(productCategory)*&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$productCategories&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;productCategory
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value=&quot;{@value}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;label=&quot;{if (@label_category) then @label_category else csc:getLocalizedAssetName(@value)}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/productCategory&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:variable&gt;
 &nbsp; &nbsp; &nbsp;&lt;productCategories censhare:_annotation.arraygroup=&quot;true&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$items&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sort select=&quot;@label&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;.&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp;&lt;/productCategories&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;rating&quot; element --&gt;
 &nbsp;&lt;!-- &lt;rating bookmarkCountCalc=&quot;1&quot; dislikeCountCalc=&quot;1&quot; followerCountCalc=&quot;1&quot; likeCountCalc=&quot;8&quot;&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;own value=&quot;4.0&quot; fullStars=&quot;4&quot; emptyStars=&quot;0&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;avg value=&quot;4.5&quot; fullStars=&quot;4&quot; emptyStars=&quot;0&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &lt;/rating&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;rating&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;ratingTraitElement&quot; select=&quot;traits/rating&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$ratingTraitElement&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;rating&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- copy all attributes of &quot;rating&quot; trait element --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:copy-of select=&quot;$ratingTraitElement/@*&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- create rating --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;ratings&quot; select=&quot;$ratingTraitElement/rating/value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;ownRating&quot; select=&quot;$ratings[@party=$loggedInPartyID][1]/@value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;avgRating&quot; select=&quot;avg($ratings/@value)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$ownRating&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;own&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;value censhare:_annotation.datatype=&quot;number&quot;&gt;&lt;xsl:value-of select=&quot;$ownRating&quot;/&gt;&lt;/value&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;fullStars censhare:_annotation.datatype=&quot;number&quot;&gt;&lt;xsl:value-of select=&quot;floor($ownRating)&quot;/&gt;&lt;/fullStars&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;emptyStars censhare:_annotation.datatype=&quot;number&quot;&gt;&lt;xsl:value-of select=&quot;5-floor($ownRating)&quot;/&gt;&lt;/emptyStars&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/own&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;avg&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;value censhare:_annotation.datatype=&quot;number&quot;&gt;&lt;xsl:value-of select=&quot;$avgRating&quot;/&gt;&lt;/value&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;fullStars censhare:_annotation.datatype=&quot;number&quot;&gt;&lt;xsl:value-of select=&quot;floor($avgRating)&quot;/&gt;&lt;/fullStars&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;emptyStars censhare:_annotation.datatype=&quot;number&quot;&gt;&lt;xsl:value-of select=&quot;5-floor($avgRating)&quot;/&gt;&lt;/emptyStars&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/avg&gt;
 &nbsp; &nbsp; &nbsp;&lt;/rating&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;task&quot; element --&gt;
 &nbsp;&lt;!-- &lt;task&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;duration value=&quot;4&quot; unit=&quot;days&quot;&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;workingTime value=&quot;2&quot; unit=&quot;days&quot;&gt; --&gt;
 &nbsp;&lt;!-- &lt;/task&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;task&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenDurationString&quot; select=&quot;traits/resource_planning/@givenDuration&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenWorkingTimeString&quot; select=&quot;traits/resource_planning/@givenWorkingTime&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$givenDurationString or $givenWorkingTimeString&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;task&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$givenDurationString&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenDurationValue&quot; select=&quot;xs:double(substring-before($givenDurationString, 'w'))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenDurationUnit&quot; select=&quot;concat('w', substring-after($givenDurationString, 'w'))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;duration
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value=&quot;{cs:format-number($givenDurationValue, '#,##0.#')}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unit=&quot;{csc:getWorkingTimeUnitKey($givenDurationValue, $givenDurationUnit)}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/duration&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$givenWorkingTimeString&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenWorkingTimeValue&quot; select=&quot;if (contains($givenWorkingTimeString, 'w')) then xs:double(substring-before($givenWorkingTimeString, 'w')) else (xs:double($givenWorkingTimeString))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;givenWorkingTimeUnit&quot; select=&quot;if (contains($givenWorkingTimeString, 'w')) then concat('w', substring-after($givenWorkingTimeString, 'w')) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;workingTime
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value=&quot;{cs:format-number($givenWorkingTimeValue, '#,##0.#')}&quot;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unit=&quot;{if ($givenWorkingTimeUnit) then csc:getWorkingTimeUnitKey($givenWorkingTimeValue, $givenWorkingTimeUnit) else ()}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/workingTime&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/task&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;tasks&quot; element --&gt;
 &nbsp;&lt;!-- &lt;tasks countParent=&quot;1&quot; countPredecessor=&quot;1&quot; countSuccessor=&quot;1&quot; countChild=&quot;1&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;tasks&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;parentAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'user.task.') and @direction='parent']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;childAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'user.task.') and @direction='child']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;predecessorAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'user.dependency-finish-to-start.') and @direction='parent']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;successorAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'user.dependency-finish-to-start.') and @direction='child']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels or $childAssetRels or $predecessorAssetRels or $successorAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;tasks&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;countParent&quot; select=&quot;count($parentAssetRels)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$predecessorAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;countPredecessor&quot; select=&quot;count($predecessorAssetRels)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$successorAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;countSuccessor&quot; select=&quot;count($successorAssetRels)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$childAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;countChild&quot; select=&quot;count($childAssetRels)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/tasks&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;thumbnail&quot; element --&gt;
 &nbsp;&lt;!-- &lt;thumbnail url=&quot;/rest/service/assets/asset/id/294464/version/2/element/actual/0/storage/thumbnail/file/485731.jpg&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;thumbnail&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;storageItemUrl&quot; select=&quot;csc:findThumbnailUrl()&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$storageItemUrl&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;thumbnail url=&quot;{replace($storageItemUrl, 'censhare:///', $urlPrefix)}&quot;/&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;variants&quot; element --&gt;
 &nbsp;&lt;!-- &lt;variants&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;parent type=&quot;variant.1.&quot; label=&quot;Variant with update flag&quot; id=&quot;123456&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &nbsp; &lt;child count=&quot;1&quot;/&gt; --&gt;
 &nbsp;&lt;!-- &lt;/variants&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;variants&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;variantParentRel&quot; select=&quot;/container/asset/relations/relation[@direction='parent' and starts-with(@type, 'variant.')][1]&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;variantChildRels&quot; select=&quot;/container/asset/relations/relation[@direction='child' and starts-with(@type, 'variant.')]&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$variantParentRel or $variantChildRels&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;variants&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$variantParentRel&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;parent type=&quot;{$variantParentRel/@type}&quot; label=&quot;{cs:master-data('asset_rel_typedef')[@key=$variantParentRel/@type]/@name}&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;id&quot; select=&quot;tokenize($variantParentRel/@ref_asset, '/')[3]&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$id&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;id&quot; select=&quot;$id&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;roleElements&quot; select=&quot;$variantParentRel/traits/resource_asset/roleRelation/value&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$roleElements&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;roles censhare:_annotation.arraygroup=&quot;true&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:for-each select=&quot;$roleElements&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;role id=&quot;{@value}&quot; label=&quot;{@label_value}&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:for-each&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/roles&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/parent&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$variantChildRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;child count=&quot;{count($variantChildRels)}&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/variants&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;variantUpdates&quot; element --&gt;
 &nbsp;&lt;!-- &lt;variantUpdates countParent=&quot;1&quot; countChild=&quot;1&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;variantUpdates&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;parentAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'variant.') and @direction='parent' and traits/state/@hasUpdateContent='true']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;childAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'variant.') and @direction='child' and traits/state/@hasUpdateContent='true']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels or $childAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;variantUpdates countParent=&quot;{count($parentAssetRels)}&quot; countChild=&quot;{count($childAssetRels)}&quot;/&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;!-- creates &quot;workingCopies&quot; element --&gt;
 &nbsp;&lt;!-- &lt;workingCopies countParent=&quot;1&quot; releaseDate=&quot;2020-05-18T04:14:00Z&quot; countChild=&quot;1&quot;/&gt; --&gt;
 &nbsp;&lt;xsl:template name=&quot;workingCopies&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;parentAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'user.working-copy.') and @direction='parent']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;childAssetRels&quot; select=&quot;relations/relation[starts-with(@type, 'user.working-copy.') and @direction='child']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels or $childAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp;&lt;workingCopies&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$parentAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;countParent&quot; select=&quot;count($parentAssetRels)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;releaseDate&quot; select=&quot;traits/publication/@releaseDate&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$releaseDate&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;releaseDate&quot; select=&quot;$releaseDate&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:if test=&quot;$childAssetRels&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:attribute name=&quot;countChild&quot; select=&quot;count($childAssetRels)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp; &nbsp; &nbsp;&lt;/workingCopies&gt;
 &nbsp; &nbsp;&lt;/xsl:if&gt;
 &nbsp;&lt;/xsl:template&gt;

 &nbsp;&lt;xsl:function name=&quot;csc:findThumbnailUrl&quot; as=&quot;xs:string?&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;asset&quot; select=&quot;.&quot; as=&quot;element(asset)&quot;/&gt;
 &nbsp; &nbsp;&lt;!-- first check for thumbnail ow own asset --&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;thumbnailStorageItems&quot; as=&quot;element(storage_item)*&quot; select=&quot;$asset/actual_root/storage_items/storage_item[@type='thumbnail'] | $asset/actual_root/pages/page[1]/storage_items/storage_item[@type='thumbnail']&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:choose&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;exists($thumbnailStorageItems)&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;$thumbnailStorageItems[1]/@url&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- find asset type specific thumbnails --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;assetTypeThumbnailStorageItemUrl&quot; as=&quot;xs:string?&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- asset type slideshow --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$asset/traits/type/@type='extended-media.slideshow.'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;slideAssetId&quot; select=&quot;tokenize($asset/relations/relation[@type='user.media.'][1]/@ref_asset, '/')[3]&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;slideAsset&quot; select=&quot;if ($slideAssetId) then cs:get-asset(xs:long($slideAssetId)) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;thumbnailStorageItem&quot; select=&quot;if ($slideAsset) then $slideAsset/storage_item[@key='thumbnail'][1] else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- slide has thumbnail preview --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$thumbnailStorageItem&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;$thumbnailStorageItem/@url&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- follow media related assets --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;textAssets&quot; select=&quot;for $x in $slideAsset/child_asset_rel[@key='user.main-content.']/@child_asset return cs:get-asset($x)&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;locale&quot; select=&quot;cs:master-data('party')[@id=system-property('censhare:party-id')]/@locale&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;textAsset&quot; select=&quot;if ($textAssets) then (if ($textAssets/@language=$locale) then $textAssets[@language=$locale][1] else $textAssets[1]) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;imageAssetId&quot; select=&quot;if ($textAsset) then $textAsset/child_asset_rel[@key='actual.key-visual.']/@child_asset else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;imageAsset&quot; select=&quot;if ($imageAssetId) then cs:get-asset(xs:long($imageAssetId)) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;thumbnailStorageItem&quot; select=&quot;if ($imageAsset) then $imageAsset/storage_item[@key='thumbnail'][1] else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;if ($thumbnailStorageItem) then $thumbnailStorageItem/@url else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- asset type slide --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$asset/traits/type/@type='extended-media.slide.'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;textAssets&quot; select=&quot;for $x in $asset/relations/relation[@type='user.main-content.']/@ref_asset return cs:get-asset(xs:long(tokenize($x, '/')[3]))&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;locale&quot; select=&quot;cs:master-data('party')[@id=system-property('censhare:party-id')]/@locale&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;textAsset&quot; select=&quot;if ($textAssets) then (if ($textAssets/@language=$locale) then $textAssets[@language=$locale][1] else $textAssets[1]) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;imageAssetId&quot; select=&quot;if ($textAsset) then $textAsset/child_asset_rel[@key='actual.key-visual.']/@child_asset else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;imageAsset&quot; select=&quot;if ($imageAssetId) then cs:get-asset(xs:long($imageAssetId)) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;thumbnailStorageItem&quot; select=&quot;if ($imageAsset) then $imageAsset/storage_item[@key='thumbnail'][1] else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;if ($thumbnailStorageItem) then $thumbnailStorageItem/@url else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- asset type issue --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$asset/traits/type/@type='issue.'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;firstPlacedAssetId&quot; select=&quot;tokenize($asset/planning_root/pages/page[1]/planning_element_relations[1]/planning_element_relation[@type='target.'][1]/@ref_asset, '/')[3]&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;placedAsset&quot; select=&quot;if ($firstPlacedAssetId) then cs:get-asset(xs:long($firstPlacedAssetId)) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;thumbnailStorageItem&quot; select=&quot;if ($placedAsset) then $placedAsset/storage_item[@key='thumbnail'][1] else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:sequence select=&quot;if ($thumbnailStorageItem) then $thumbnailStorageItem/@url else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:variable&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:choose&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$assetTypeThumbnailStorageItemUrl&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;$assetTypeThumbnailStorageItemUrl&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;!-- find fallback via relation user.main-picture. --&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;mainPictureAssetId&quot; select=&quot;tokenize($asset/relations/relation[@type='user.main-picture.'][1]/@ref_asset, '/')[3]&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;mainPictureAsset&quot; select=&quot;if ($mainPictureAssetId) then cs:get-asset(xs:long($mainPictureAssetId)) else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:variable name=&quot;thumbnailStorageItem&quot; select=&quot;if ($mainPictureAsset) then $mainPictureAsset/storage_item[@key='thumbnail'][1] else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;if ($thumbnailStorageItem) then $thumbnailStorageItem/@url else ()&quot;/&gt;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;/xsl:choose&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:otherwise&gt;
 &nbsp; &nbsp;&lt;/xsl:choose&gt;
 &nbsp;&lt;/xsl:function&gt;

 &nbsp;&lt;!-- get working time text --&gt;
 &nbsp;&lt;xsl:function name=&quot;csc:getWorkingTimeUnitKey&quot; as=&quot;xs:string&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:param name=&quot;value&quot; as=&quot;xs:double&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:param name=&quot;unit&quot; as=&quot;xs:string&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;valueString&quot; select=&quot;cs:format-number($value, '#,##0.#')&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:choose&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$unit='wmo'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;if ($valueString='1') then 'month' else 'months'&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$unit='ww'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;if ($valueString='1') then 'week' else 'weeks'&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$unit='wd'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;if ($valueString='1') then 'day' else 'days'&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:when test=&quot;$unit='wh'&quot;&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;if ($valueString='1') then 'hour' else 'hours'&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:when&gt;
 &nbsp; &nbsp; &nbsp;&lt;xsl:otherwise&gt;
 &nbsp; &nbsp; &nbsp; &nbsp;&lt;xsl:value-of select=&quot;cs:master-data('unit')[@key=$unit]/@name&quot;/&gt;
 &nbsp; &nbsp; &nbsp;&lt;/xsl:otherwise&gt;
 &nbsp; &nbsp;&lt;/xsl:choose&gt;
 &nbsp;&lt;/xsl:function&gt;

 &nbsp;&lt;!-- get localized asset name of given asset ID or resource key --&gt;
 &nbsp;&lt;xsl:function name=&quot;csc:getLocalizedAssetName&quot; as=&quot;xs:string?&quot;&gt;
 &nbsp; &nbsp;&lt;xsl:param name=&quot;value&quot; as=&quot;xs:string&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;asset&quot; select=&quot;if ($value castable as xs:long) then cs:get-asset(xs:long($value)) else cs:get-resource-asset($value)&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:variable name=&quot;name&quot; select=&quot;if ($asset) then $asset/asset_feature[@feature='censhare:name' and @language=$language][1]/@value_string else ()&quot;/&gt;
 &nbsp; &nbsp;&lt;xsl:value-of select=&quot;if ($name) then $name else $asset/@name&quot;/&gt;
 &nbsp;&lt;/xsl:function&gt;

&lt;/xsl:stylesheet&gt;

</pre>
</body>
</html>
